<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<link href="http://vjs.zencdn.net/6.6.3/video-js.css" rel="stylesheet">
	<script src="http://vjs.zencdn.net/6.6.3/video.js"></script>

	<script> 
		// wait for the DOM to be loaded 
		$(document).ready(function () {
			var hostUrl = 'localhost:51080';

			$("#mybutton").click(function () {
				$.get("http://localhost:51080/api/Car", function (data, status) {
					alert("Data: " + JSON.stringify(data) + "\nStatus: " + status);
				});
			});

			var socket;
			elSocketCreate = $("#btnSocket");
			elSocketMessage = $("#btnSocketMessage");
			elSocketClose = $("#btnSocketClose");

			// Web socket
			elSocketCreate.click(function () {
				var scheme = document.location.protocol == "https:" ? "wss" : "ws";
				var port = document.location.port ? (":" + document.location.port) : "";
				var socketUrl = scheme + "://" + hostUrl + "/ws";

				socket = new WebSocket(socketUrl);

				// Event: Socket opened
				socket.onopen = event => {
					console.log(`Socket open at ${socketUrl}`);
				};

				// Event: Socket closed
				socket.onclose = event => {
					console.log('Socket closed');
				};

				// Event: Socket error
				socket.onerror = event => {
					console.error('Socket error');
				};

				// Event: Socket receive message
				socket.onmessage = event => {
					console.log(`Message: ${event.data}`);
					console.log(event);
				};

				elSocketCreate[0].disabled = true;
				elSocketMessage[0].disabled = false;
				elSocketClose[0].disabled = false;
				console.info('Socket info:');
				console.info(socket);
			});

			// Send message over socket
			elSocketMessage.click(function () {
				if (webSocket.readyState == WebSocket.OPEN) {
					socket.send(JSON.stringify({ message: '俺のこと、愛してる？' }));
				}
				else {
					console.error("Connection is closed");
				}
				
				// socket.send({ message: '俺のこと、愛してる？' });
			});

			// Send message over socket
			elSocketClose.click(function (e) {
				socket.close();

				elSocketCreate[0].disabled = false;
				elSocketClose[0].disabled = true;
				elSocketMessage[0].disabled = true;
			});

			// Form submit
			$("#myform").submit(function (e) {

				//prevent Default functionality
				e.preventDefault();
				console.log(e);
				//get the action-url of the form
				var actionurl = e.currentTarget.action;

				var fileUpload = $("#myfile").get(0);
				var files = fileUpload.files;
				var data = new FormData();
				for (var i = 0; i < files.length; i++) {
					data.append(files[i].name, files[i]);
				}

				$('input[type=text]').each((index, element) => {
					data.append(element.name, element.value);
				})

				//do your own request an handle the results
				$.ajax({
					//url: "http://localhost:51080/api/Car/UploadSmallFilesAjax",
					url: "http://localhost:51080/api/Car/UploadLargeFile",
					type: "POST",
					data: data,
					contentType: false,
					processData: false,

					xhr: function () {
						//upload Progress
						var xhr = $.ajaxSettings.xhr();
						if (xhr.upload) {
							xhr.upload.addEventListener('progress', function (event) {
								var percent = 0;
								var position = event.loaded || event.position;
								var total = event.total;
								if (event.lengthComputable) {
									percent = Math.ceil(position / total * 100);
								}
								//update progressbar
								var txtPercent = percent + "%";
								$("#percent").text(txtPercent);
								$("#percent").css({ "width": txtPercent });
								$("#percent").attr('aria-valuenow', percent);
							}, true);
						}
						return xhr;
					},
					success: function (message) {
						$("#status").text(JSON.stringify(message));
					},
					error: function () {
						alert("There was error uploading files!");
					}
				});
			});
		}); 
	</script>
</head>

<body>
	<div class="container">
		<div class="well">
			<form id="myform" method="post" enctype="multipart/form-data">
				<div>
					<p>Upload one or more files using this form:</p>
					<label>Model Id</label>
					<input type="text" name="modelid" value="123456" />

					<label>Model Name</label>
					<input type="text" name="modelname" value="Mazda CX 5" />

					<label>Model Version</label>
					<input type="text" name="version" value="7654" />

					<span class="btn btn-file btn-warning">
						Upload
						<input type="file" name="files" id="myfile" multiple />
					</span>
				</div>
				<div>
					<input type="submit" value="Upload" class="btn btn-default" />
					<button id="mybutton" type="button" class="btn btn-primary">Test API</button>
				</div>
			</form>
		</div>
		<div class="well">
			<div class="progress">
				<div id="percent" class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0"
				 aria-valuemax="100" style="width:0%">
					70%
				</div>
			</div>
		</div>
	</div>


	<div id="status"></div>
	<!-- <video width="400" controls>
		<source src="http://localhost:51080/api/Car/DownloadFileAsyn?filename=jellyfish-25-mbps-hd-hevc.mp4" type="video/mp4">
	</video> -->


	<video id="my-video" class="video-js" controls preload="metadata" width="640" height="264">
		<source src="http://localhost:51080/api/Car/PlayVideo?filename=jellyfish-25-mbps-hd-hevc.mp4" type='video/mp4'>
	</video>

	<button id="btnSocket" type="button" class="btn btn-primary">Create Web Socket</button>
	<button id="btnSocketMessage" type="button" class="btn btn-primary" disabled>Send socket message</button>
	<button id="btnSocketClose" type="button" class="btn btn-primary" disabled>Close socket</button>
</body>

</html>